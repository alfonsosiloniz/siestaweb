#!/bin/sh
# by pepper 07/05/2007

function get_modo_video () {
    # Buscar nº de modulos que estan usando el modulo video
    M_V=(`lsmod | grep ^video`)
    if [ ${M_V[2]} = 0 ] ; then
        ModoVideo="Apagado"
    else
        ModoVideo="Encendido"
    fi
}

echo "Content-type: text/html"
echo ""
echo "<html>"
echo "<title>M750T - Estado del box</title>"
echo "<meta http-equiv=\"refresh\" content=\"600\" />"
echo "<link href=\"/sincro/img/m740.ico\" rel=\"shortcut icon\"></link>"
echo "<link href=\"/sincro/css/estilos.css\" rel=\"stylesheet\" type=\"text/css\"></link>"
echo "<script language=\"JavaScript\" src=\"/sincro/js/ajax.js\"></script>"
echo "<script language=\"JavaScript\" src=\"/sincro/js/navigator.js\"></script>"
echo "<script language=\"JavaScript\" src=\"/sincro/js/controlenviar.js\"></script>"
echo "<script language=\"JavaScript\" src=\"/sincro/js/fechasOp.js\"></script>"
echo "<script language=\"JavaScript\">"
echo "function reboot() {"
echo "  if (confirm(\"¿Confirma el reboot del Gigaset?\")) {"
echo "    makeRequest(\"/cgi-bin/box/reboot?\" + new Date().getTime(), \"mostrarXMLRespuesta\");"
echo "    alert(\"Se ha mandado la petición de Reboot.\nEn unos segundos el sistema se reiniciará\");"
echo "  }"
echo "}"
echo "function reloadCrontab() {"
echo "  if (confirm(\"¿Confirma la recarga de /var/etc/root.crontab?\")) {"
echo "    makeRequest(\"/cgi-bin/box/reloadCrontab?\" + new Date().getTime(), \"mostrarXMLRespuesta\");"
echo "    alert(\"Se ha mandado la petición de Reload.\nLa página se recargará para comprobar el resultado.\");"
echo "    document.location.reload();"
echo "  }"
echo "}"
echo "function downloadSincroImg() {"
echo "  if (confirm(\"El proceso de descarga de las imágenes tarda unos 6 minutos.\n¿Confirma la descarga de las imágenes de la sincroguia?\")) {"
echo "    makeRequest(\"/cgi-bin/sincro/getsincroimg?\" + new Date().getTime(), \"mostrarXMLRespuesta\");"
echo "    alert(\"Se ha mandado la petición de Descarga.\nSigue el proceso en la página de log de la aplicación.\");"
echo "    document.location.href=\"/cgi-bin/sincro/verlog\";"
echo "  }"
echo "}"
echo "function actCacheCanales() {"
echo "  if (confirm(\"La generacion de la cache de los canales tarda unos 50 minutos.\n¿Confirma la actualización de dicha caché?\")) {"
echo "    makeRequest(\"/cgi-bin/sincro/sincroXML.cache.bg?\" + new Date().getTime(), \"mostrarXMLRespuesta\");"
echo "    alert(\"Se ha mandado la petición de actualización de la caché de los canales.\nSigue el proceso en la página de log de la aplicación.\");"
echo "    document.location.href=\"/cgi-bin/sincro/verlog\";"
echo "  }"
echo "}"
echo "function actCachePgmAct() {"
echo "  if (confirm(\"La generacion de la cache del programa actual tarda unos 2 minutos.\n¿Confirma la actualización de dicha caché?\")) {"
echo "    makeRequest(\"/cgi-bin/sincro/pgmactualXML.cache.bg?\" + new Date().getTime(), \"mostrarXMLRespuesta\");"
echo "    alert(\"Se ha mandado la petición de actualización de la caché del programa actual.\nSigue el proceso en la página de log de la aplicación.\");"
echo "    document.location.href=\"/cgi-bin/sincro/verlog\";"
echo "  }"
echo "}"
echo "function mostrarXMLRespuesta() {}"
echo "</script>"
echo "<body bgcolor=\"#FFFFFF\">"
echo "<form name=\"formulario\">"
echo "  <div align=\"center\"><p><font class=\"titPag\">M750T EPG</font></p></div>"
echo "  <div align=\"center\"><font class=\"subTitPag\">Estado del box</font></div>"
echo "  <p>"
echo "      <div align=\"center\" class=\"txtNormal\"><a href=\"javascript:history.back()\">Atrás</a> | <a href=\"/cgi-bin/sincro/pgmactualXML\">Inicio</a> | "
echo "      <a href=\"/cgi-bin/crid/timerXML\">Grabaciones Pendientes</a> | <a href=\"/cgi-bin/crid/videoXML\">Grabaciones Realizadas</a> | "
echo "      <a href=\"/index.html\">Salir</a><br/><br/><a href=\"/osd/osd2tcp.html\">Control OSD</a> | <a href=\"/cgi-bin/box/show/var/etc\">Editor / Explorador de Archivos</a> | "
echo "      <a href=\"/cgi-bin/box/selectLiveTv\">Ver LiveTV</a> | <a href=\"/sincro/visualizarts.html\">Ver LiveTV+10</a> | <a href=\"/ssh/sshconn.html\">SSH</a></div>"
echo "  </p>"
get_modo_video
echo "  <table width=\"98%\" border=\"0\" cellspacing=\"0\" cellpadding=\"2\" align=\"center\"  class=\"borderTabla2\">"
echo "  <tr>"
echo "    <td class=\"fila titTabla\"  bgcolor=\"#ffb310\" align=\"center\">Estado: $ModoVideo</td>"
echo "  </tr>"
echo "  <tr>"
echo "    <td class=\"fila titTabla\"  bgcolor=\"#ffb310\" align=\"center\">Espacio en disco</td>"
echo "  </tr>"
echo "  <tr>"
echo "    <td class=\"fila\" align=\"left\"><pre>`df 2> /dev/null`</pre></td>"
echo "  </tr>"
echo "  <tr>"
echo "    <td class=\"fila titTabla\"  bgcolor=\"#ffb310\" align=\"center\">Puntos de montaje</td>"
echo "  </tr>"
echo "  <tr>"
echo "    <td class=\"fila\" align=\"left\"><pre>`cat /proc/mounts`</pre></td>"
echo "  </tr>"
echo "  <tr>"
echo "    <td class=\"fila titTabla\"  bgcolor=\"#ffb310\" align=\"center\">Uso de memoria</td>"
echo "  </tr>"
echo "  <tr>"
echo "    <td class=\"fila\" align=\"left\"><pre>`free`</pre></td>"
echo "  </tr>"
echo "  <tr>"
echo "    <td class=\"fila titTabla\"  bgcolor=\"#ffb310\" align=\"center\">Uptime - Carga del sistema</td>"
echo "  </tr>"
echo "  <tr>"
echo "    <td class=\"fila\" align=\"left\"><pre>`uptime`</pre></td>"
echo "  </tr>"
echo "  <tr>"
echo "    <td class=\"fila titTabla\"  bgcolor=\"#ffb310\" align=\"center\">Procesos Planificados</td>"
echo "  </tr>"
echo "  <tr>"
echo "    <td class=\"fila\" align=\"left\"><pre>`crontab -l`</pre></td>"
echo "  </tr>"
echo "  <tr>"
echo "    <td class=\"fila titTabla\"  bgcolor=\"#ffb310\" align=\"center\">Procesos</td>"
echo "  </tr>"
echo "  <tr>"
echo "    <td class=\"fila\" align=\"left\"><pre>`ps -axfw`</pre></td>"
echo "  </tr>"
echo "  <tr>"
echo "  </table><br/>"
echo "  <div align=\"center\"><input type=\"button\" value=\"Descargar Imágenes Sincro.\" onclick=\"downloadSincroImg();\">&nbsp;&nbsp;<input type=\"button\" value=\"Recargar root.crontab\" onclick=\"reloadCrontab();\">&nbsp;&nbsp;<input type=\"button\" value=\"Reiniciar Gigaset\" onclick=\"reboot();\"><br><br>"
echo "  <input type=\"button\" value=\"Act. Caché Pgm. Actual\" onclick=\"actCachePgmAct();\">&nbsp;&nbsp;<input type=\"button\" value=\"Act. Caché Canales\" onclick=\"actCacheCanales();\"></div>"
echo "  <p>"
echo "      <div align=\"center\" class=\"txtNormal\"><a href=\"javascript:history.back()\">Atrás</a> | <a href=\"/cgi-bin/sincro/pgmactualXML\">Inicio</a> | "
echo "      <a href=\"/cgi-bin/crid/timerXML\">Grabaciones Pendientes</a> | <a href=\"/cgi-bin/crid/videoXML\">Grabaciones Realizadas</a> | "
echo "      <a href=\"/index.html\">Salir</a><br/><br/><a href=\"/osd/osd2tcp.html\">Control OSD</a> | <a href=\"/cgi-bin/box/show/var/etc\">Editor / Explorador de Archivos</a> | "
echo "      <a href=\"/cgi-bin/box/selectLiveTv\">Ver LiveTV</a> | <a href=\"/sincro/visualizarts.html\">Ver LiveTV+10</a> | <a href=\"/ssh/sshconn.html\">SSH</a><br/><br/>"
echo "      <a href=\"/autores.html\">Autores</a> | <a href=\"/cgi-bin/sincro/verlog\">Ver Log</a></div>"
echo "  </p>"
echo " </form>"
echo "</body>"
echo "</html>"
