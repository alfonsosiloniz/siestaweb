#!/bin/bash 
# by pepper 03/04/2007
# Script que genera los XML de todos los canales, guardandolos en el directorio de Cache.
# Admite como parametro una lista de canales a actualizar, en el siguiente formato: TV3:TV1:...:
# Notar que siempre hay que acabarla con ":"
# Si no se pasa parametro, se actualizan todos los canales

# Ejecutamos el script con baja prioridad
renice 20 $$ > /dev/null

# Obtener parametros
numParams=$#
params=$1

# Configurar entorno
source ../www-setup
SORT_CHANNELS=$Cache/sort_channels.txt
horaUTCinicial=`date +%s`

# Comprobar marca de generacion de cache XML
[ -f ${Cache}/sincrochannelXML.cache.generating ] && exit -1

# Crear marca de generacion de cache XML
touch ${Cache}/sincrochannelXML.cache.generating

# Log del proceso
echo "`date` Iniciando generacion XML de sincroguia [host: `hostname`],[horaUTCinicial: $horaUTCinicial]" > $Cache/sincro.cache.log
echo -n "" > $Cache/sincro.cache.err

if [ $numParams -eq 0 ]; then
    #Nos guardamos la horaUTCinicial con la que hemos generado la parrilla, por si nos interesa consultarla a posteriori
    echo "$horaUTCinicial" > $Cache/horaUTCinicial.txt
fi

# Generamos el fichero sort_channels.txt con la misma ordenación del gigaset
[ ! -f $SORT_CHANNELS ] && ./sortChannels

if [ -f $SORT_CHANNELS ]; then
	ListaCanales=`cat $SORT_CHANNELS`
else
	ListaCanales=$EPG_PATH/*.db
fi

i=1
for Sincrofile in $ListaCanales ; do
	cp $Sincrofile /tmp/`basename $Sincrofile` >> $Cache/sincro.cache.log 2>> $Cache/sincro.cache.err
	if [ $? = 0 -a -f /tmp/`basename $Sincrofile` ] ; then
		CHANNEL_ID=`echo "$Sincrofile" | cut -d"_" -f2 | cut -d"." -f1`
		found=1
		if [ $numParams -eq 1 ]; then
			found=`echo $params | grep "$CHANNEL_ID:" | wc -l`
			# Si solo se actualizan algunos canales, no actualizamos la parrilla, puesto que se pintaría mal
			horaUTCinicial="-1"
		fi
		if [ $found -eq 1 ]; then
			if [ -f $Sincrofile ]; then
				echo -n "`date` Generando Sincro de Canal $CHANNEL_ID" >> $Cache/sincro.cache.log 2>> $Cache/sincro.cache.err
				CACHE_FILE=${Cache}/sincrochannelXML.cache.$CHANNEL_ID
				touch ${CACHE_FILE}.generating
				./sincrochannelXML.cache /tmp/`basename $Sincrofile` $i $horaUTCinicial >> $Cache/sincro.cache.log 2>> $Cache/sincro.cache.err
				rm -f ${CACHE_FILE}.generating
			fi
		fi
	fi
	i=$((i+1))
    rm -f /tmp/`basename $Sincrofile`
done
echo "`date` Generacion de los XML de sincroguia finalizada [host: `hostname`]" >> $Cache/sincro.cache.log

# Descarga de imagenes de sincroguia
[ "Z$DESCARGA_IMG" = "Zsi" -a $numParams -eq 0 ] && run-http.sh /cgi-bin/sincro/getsincroimg

# Eliminar marca de generacion de cache XML
rm -f ${Cache}/sincrochannelXML.cache.generating
rm -f ${Cache}/pgmactual.cache.generating